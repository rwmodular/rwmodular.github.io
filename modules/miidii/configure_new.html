<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="/style.min.css" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP" type="text/css">
        <link rel="shortcut icon" type="image/png" href="/assets/favicon.png">
        <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/favicon.png">
        <title>random works modular - miidii config</title>

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-P1TS1CFXSL"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-P1TS1CFXSL');
        </script>

        <style>
            #message {
                padding: 20px;
                border: solid 2px;
                text-align: center;
                font-weight: bold;
                background-color: #89d589;
                display: none;
            }
            #message.error {
                background-color: #ffa2a2;
            }
            #info {
                text-align: right;
            }
            #enter_firmware {
                float: right;
            }
            #config_form {
                display: none;
                margin-top: 20px;
                font-size: 1.2rem;
            }
            #config_form * {
                font-size: 1.2rem;
            }
            .form-row {
                padding: 10px 0;
            }
            .show {
                display: block!important;
            }
            .target {
              border: solid 1px;
              border-radius: 12px;
              padding: 12px;
              margin-bottom: 20px;
              position: relative;
              display: none;
            }
            .changeaddr {
              float: right;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
        <script type="module">

          var max_targets = 2;
          var num_targets = 1;
          var miidii_input = undefined;
          var miidii_output = undefined;

          function get(id) {
            return document.getElementById(id);
          }

          function show(id) {
            var ele = get(id);
            if(!ele.classList.contains("show")) {
              ele.classList.add("show");
            }
          }

          function showMessage(html, error) {
              var obj = get("message");
              obj.classList.remove("error");
              if(error) {
                  obj.classList.add("error");
              }
              obj.innerHTML = html;
              obj.classList.add("show");
          }

          function getConfig() {
            miidii_input.addOneTimeListener("sysex", e => {
                var d = e.message.data;
                if (d[4] === 0x1f)
                {
                  num_targets = 1;
                  get("info").innerHTML = "connected to miidii version " + d[6] + "." + d[7] + "." + d[8];
                  if(d[6] < 1) {
                    showMessage("Please update your miidii module or use the old configuration page <a href=\"configure_old.html\">here</a>", true);
                  }
                  if(d[9] == 0x77 && d[10] == 0x01) {
                    var count = d[11];
                    if(count < 1) {
                      show("target1");
                    }
                    else 
                    {
                      if(count > max_targets) {
                          count = max_targets;
                      }
                      num_targets = count;
                      for(var i=0; i<num_targets; i++) {
                        var n = 12 + (i*3);
                        var type = d[n];
                        var midi = d[n + 1];
                        var i2c = d[n + 2];

                        var name = "target" + (i + 1);
                        get(name + "_type").value = (type == 1 && i2c == 0x75) ? 11 : type;
                        get(name + "_midi").value = midi;
                        get(name + "_i2c").value = "0x" + i2c.toString(16);

                        show(name);
                      }

                      get("midi_led_off").checked = d[(num_targets * 3) + 12] == 1;
                    }
                  }
                  else
                  {
                    get("midi_led_off").checked = d[11] == 1;

                    get("target1_midi").value = d[9];
                    get("target1_type").value = d[10] == 2 ? "2" : "1";
                    get("target1_i2c").value = "0x" + d[10].toString(16);
                    show("target1");
                  }
                    
                  show("config_form");
                  show("enter_firmware");
                }
              });
              miidii_output.sendSysex([0x7d, 0x00, 0x00], [0x11]);
          }

          function writeConfig() {
            var d = [0x12];
            d[1] = 0x77;
            d[2] = 0x01;
            d[3] = num_targets;
            
            for(var i=0; i<num_targets; i++) {
              var n = 4 + (i*3);
              var name = "target" + (i+1);

              var type = get(name + "_type").value;
              d[n] = type == "1" || type == "11" ? 1 : 0;
              d[n+1] = Number(get(name + "_midi").value);
              d[n+2] = Number(get(name + "_i2c").value);
            }

            d[(num_targets * 3) + 4] = get("midi_led_off").checked ? 1 : 0;
            miidii_output.sendSysex([0x7d, 0x00, 0x00], d);
          }

          function onEnabled() {
              var target_name = "miidii";
              miidii_input = WebMidi.getInputByName(target_name);
              miidii_output = WebMidi.getOutputByName(target_name);
              if(miidii_input === undefined || miidii_output === undefined) {
                  showMessage("No device detected", true);
                  return;
              }
            
              getConfig();
          }
          
          function addTarget() {
            if(num_targets < 2) {
              num_targets++;
              get("target" + num_targets).classList.add("show");
            }
          }

          function removeTarget() {
            if(num_targets > 1) {
              get("target" + num_targets).classList.remove("show");
              num_targets--;
            }
          }

          function setJFAddressClick(event) {
            var addr = event.target.classList.contains("setaddr2") ? 2 : 1;
            if(confirm("Are you sure you want to change the address of Just Friends to " + addr + "? Please ensure that only one Just Friends module is connected before continuing.")) {
              miidii_output.sendSysex([0x7d, 0x00, 0x00], [0x13, 0x1F, addr]);
            }
          }

          window.addEventListener('DOMContentLoaded',function () {
            WebMidi
            .enable({sysex: true})
            .then(onEnabled)
            .catch(err => alert(err));

            get("save_btn").onclick = function() {
                writeConfig();
            };

            get("add_btn").onclick = function() {
              addTarget();
            };

            get("remove_btn").onclick = function() {
              removeTarget();
            }

            get("enter_firmware").onclick = function() {
              miidii_output.sendSysex([0x7d, 0x00, 0x00], [0x13, 0x11, 0x01]);
            }

            var setjfaddrbtns = document.getElementsByClassName("setjfaddr");
            for(var i=0; i<setjfaddrbtns.length; i++) {
              setjfaddrbtns[i].onclick = setJFAddressClick;
            }

            var type_selects = document.getElementsByClassName("target_type");
            for(var i=0; i<type_selects.length; i++) {
              type_selects[i].addEventListener("change", function(event) {
                var target_i2c = event.target.parentElement.getElementsByClassName("target_i2c");
                if(event.target.value == "1") {
                  target_i2c[0].value = "0x70";
                }
                else if(event.target.value == "11") {
                  target_i2c[0].value = "0x75";
                }
              });
            }
          });
        </script>
    </head>
    <body>
        <div class="nav">
            <div class="burger">
                <img src="/assets/burger.png" />
            </div>
            <a href="/"><img class="logo" src="/assets/logo.png" /></a>
            <ul class="nav-items">
                <li><a href="/modules/">modules</a></li>
                <li><a href="/retailers/">retailers</a></li>
                <li><a href="/projects/">projects</a></li>                
                <li><a href="/about/">about</a></li>
                <li>
                    <a href="https://www.youtube.com/channel/UCCGlK9hnJcmzP-reK1QWIQg" title="YouTube" class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path xmlns="http://www.w3.org/2000/svg" d="M 12 4 C 12 4 5.7455469 3.9999687 4.1855469 4.4179688 C 3.3245469 4.6479688 2.6479687 5.3255469 2.4179688 6.1855469 C 1.9999687 7.7455469 2 12 2 12 C 2 12 1.9999687 16.254453 2.4179688 17.814453 C 2.6479687 18.675453 3.3255469 19.352031 4.1855469 19.582031 C 5.7455469 20.000031 12 20 12 20 C 12 20 18.254453 20.000031 19.814453 19.582031 C 20.674453 19.352031 21.352031 18.674453 21.582031 17.814453 C 22.000031 16.254453 22 12 22 12 C 22 12 22.000031 7.7455469 21.582031 6.1855469 C 21.352031 5.3255469 20.674453 4.6479688 19.814453 4.4179688 C 18.254453 3.9999687 12 4 12 4 z M 12 6 C 14.882 6 18.490875 6.1336094 19.296875 6.3496094 C 19.465875 6.3946094 19.604391 6.533125 19.650391 6.703125 C 19.891391 7.601125 20 10.342 20 12 C 20 13.658 19.891391 16.397875 19.650391 17.296875 C 19.605391 17.465875 19.466875 17.604391 19.296875 17.650391 C 18.491875 17.866391 14.882 18 12 18 C 9.119 18 5.510125 17.866391 4.703125 17.650391 C 4.534125 17.605391 4.3956094 17.466875 4.3496094 17.296875 C 4.1086094 16.398875 4 13.658 4 12 C 4 10.342 4.1086094 7.6011719 4.3496094 6.7011719 C 4.3946094 6.5331719 4.533125 6.3946094 4.703125 6.3496094 C 5.508125 6.1336094 9.118 6 12 6 z M 10 8.5351562 L 10 15.464844 L 16 12 L 10 8.5351562 z"/></svg>
                        <span>YouTube</span>
                    </a>
                </li>
                <li>
                    <a href="https://www.instagram.com/rw_modular/" title="Instagram" class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="insta"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
                        <span>Instagram</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="content">
            <div class="page">
                <h1 class="title">miidii configuration</h1>

                <div class="spotlight">
                    <div class="spotlight-panel">
                        <div class="spotlight-panel-inner">
                            <div id="message"></div>
                            <div id="info"></div>
                            <div><input type="button" id="enter_firmware" value="Enter Firmware Program Mode"/></div>
                            <form id="config_form">
                                <div class="form-row">
                                    <label for="midi_led_off">disable midi led</label>
                                    <input type="checkbox" id="midi_led_off"></checkbox>
                                </div>
                                <div id="target1" class="form-row target">
                                    <div id="target1_changeaddr" class="changeaddr">
                                      <input type="button" value="Set Address 1" class="setjfaddr setaddr1">
                                      <br/>
                                      <input type="button" value="Set Address 2" class="setjfaddr setaddr2">
                                    </div>

                                    <label for="target1_type">device </label>
                                    <select id="target1_type" class="target_type">
                                      <option value="1">Just Friends Address 1</option>
                                      <option value="11">Just Friends Address 2</option>
                                    </select>
                                    <br/><br/>

                                    <label for="target1_midi">midi channel </label>
                                    <select id="target1_midi">
                                        <option>1</option>
                                        <option>2</option>
                                        <option>3</option>
                                        <option>4</option>
                                        <option>5</option>
                                        <option>6</option>
                                        <option>7</option>
                                        <option>8</option>
                                        <option>9</option>
                                        <option>10</option>
                                        <option>11</option>
                                        <option>12</option>
                                        <option>13</option>
                                        <option>14</option>
                                        <option>15</option>
                                        <option>16</option>
                                    </select>
                                    <div style="font-size:0.8rem">* in six monosynths mode one channel is used per voice starting from the selected channel looping back to 1 if it goes beyond 16</div>
                                    <br/>

                                    <label for="target1_i2c">i2c address </label>
                                    <input type="text" id="target1_i2c" pattern="0[xX][0-9a-fA-F]{1,2}" value="0x70" class="target_i2c" required/>
                                </div>
                                <div id="target2" class="form-row target">
                                    <div id="target1_changeaddr" class="changeaddr">
                                      <input type="button" value="Set Address 1" class="setjfaddr setaddr1">
                                      <br/>
                                      <input type="button" value="Set Address 2" class="setjfaddr setaddr2">
                                    </div>

                                    <label for="target2_type">device </label>
                                    <select id="target2_type" class="target_type">
                                      <option value="1">Just Friends Address 1</option>
                                      <option value="11">Just Friends Address 2</option>
                                    </select>
                                    <br/><br/>

                                    <label for="target2_midi">midi channel </label>
                                    <select id="target2_midi">
                                        <option>1</option>
                                        <option>2</option>
                                        <option>3</option>
                                        <option>4</option>
                                        <option>5</option>
                                        <option>6</option>
                                        <option>7</option>
                                        <option>8</option>
                                        <option>9</option>
                                        <option>10</option>
                                        <option>11</option>
                                        <option>12</option>
                                        <option>13</option>
                                        <option>14</option>
                                        <option>15</option>
                                        <option>16</option>
                                    </select>
                                    <div style="font-size:0.8rem">* in six monosynths mode one channel is used per voice starting from the selected channel looping back to 1 if it goes beyond 16</div>
                                    <br/>

                                    <label for="target2_i2c">i2c address </label>
                                    <input type="text" id="target2_i2c" pattern="0[xX][0-9a-fA-F]{1,2}" value="0x70" class="target_i2c" required/>
                                </div>
                                
                                <div class="form-row">
                                    <input type="submit" id="save_btn" value="Save" />
                                    <input type="button" id="add_btn" value="Add" />
                                    <input type="button" id="remove_btn" value="Remove" />
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            © 2025 random works modular
        </div>
    </body>
    <script>
        var b = document.getElementsByClassName("burger")[0];
        b.addEventListener("click", function() {
            var m = document.getElementsByClassName("nav-items")[0];
            m.classList.toggle("show");
        });
    </script>
</html>